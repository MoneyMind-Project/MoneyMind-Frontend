<div [class]="dialogClass">
  <button matIconButton class="close-btn" (click)="close()" aria-label="Cerrar">
    <mat-icon>close</mat-icon>
  </button>

  <div *ngIf="step === 1" class="step-1-container">
    <!-- Modo upload con drag & drop -->
    <ng-container *ngIf="mode === 'upload'">
      <h2 class="dialog-title">Sube tu recibo</h2>

      <div
        class="drag-drop-area"
        [class.drag-over]="isDragOver"
        [class.has-file]="selectedFile"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        (click)="fileInput.click()"
      >
        <!-- Área de drag & drop -->
        <div class="upload-content" *ngIf="!selectedFile && !loading">
          <mat-icon class="upload-icon">cloud_upload</mat-icon>
          <div class="upload-text">
            <p class="primary-text">Arrastra y suelta tu archivo aquí</p>
            <p class="secondary-text">o <span class="browse-link">busca</span></p>
          </div>
          <p class="file-types">Soporta: JPEG, JPG, PNG</p>
        </div>

        <!-- Preview del archivo seleccionado -->
        <div class="file-preview" *ngIf="selectedFile && !loading">
          <mat-icon class="file-icon">image</mat-icon>
          <div class="file-info">
            <p class="file-name">{{ selectedFile.name }}</p>
            <p class="file-size">{{ formatFileSize(selectedFile.size) }}</p>
          </div>
          <button
            matIconButton
            class="remove-file-btn"
            (click)="removeFile($event)"
            aria-label="Remover archivo"
          >
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Loading state -->
        <div class="loading-content" *ngIf="loading">
          <mat-icon class="loading-icon">hourglass_empty</mat-icon>
          <p class="loading-text">Procesando...</p>
          <div class="loading-bar">
            <div class="loading-progress"></div>
          </div>
        </div>
      </div>

      <!-- Input oculto -->
      <input
        #fileInput
        type="file"
        accept="image/*"
        (change)="onFileSelected($event)"
        class="hidden-input"
      />

      <div *ngIf="isImageWrong" class="form-error">
        {{ errorMessage }}
      </div>

      <!-- Botones de acción -->
      <div class="action-buttons">
        <button
          mat-stroked-button
          color="warn"
          (click)="close()"
          class="cancel-btn"
        >
          Cancelar
        </button>
        <button
          mat-flat-button
          color="primary"
          (click)="processReceipt()"
          [disabled]="!selectedFile || loading"
          class="process-btn"
        >
          <mat-icon *ngIf="!loading">send</mat-icon>
          {{ loading ? 'Procesando...' : 'Procesar Recibo' }}
        </button>
      </div>
    </ng-container>

    <!-- Modo cámara mejorado -->
    <ng-container *ngIf="mode === 'camera'">
      <h2 class="dialog-title">Escanea tu recibo</h2>

      <!-- Container principal del escáner -->
      <div class="scanner-container" [class.mobile-scanner]="isMobileDevice">

        <!-- Área de captura de video -->
        <div class="camera-frame" *ngIf="!loading">
          <video
            #video
            [width]="cameraWidth"
            [height]="cameraHeight"
            autoplay
            playsinline
            class="camera-video"
          ></video>

          <!-- Overlay del escáner -->
          <div class="scanner-overlay">
            <!-- Marco de enfoque -->
            <div class="focus-frame">
              <div class="corner top-left"></div>
              <div class="corner top-right"></div>
              <div class="corner bottom-left"></div>
              <div class="corner bottom-right"></div>
            </div>

            <!-- Línea de escaneo -->
            <div class="scan-line"></div>
          </div>

          <!-- Instrucciones -->
          <div class="camera-instructions">
            <p>Centra el recibo en el marco</p>
          </div>
        </div>

        <!-- Canvas oculto para captura -->
        <canvas
          #canvas
          [width]="cameraWidth"
          [height]="cameraHeight"
          class="hidden-canvas"
        ></canvas>

        <!-- Vista de imagen capturada durante el procesamiento -->
        <div class="captured-frame" *ngIf="loading">
          <canvas
            #previewCanvas
            [width]="cameraWidth"
            [height]="cameraHeight"
            class="preview-canvas"
          ></canvas>

          <!-- Overlay de escaneo con animación -->
          <div class="scanning-overlay">
            <div class="scanning-animation">
              <div class="scan-beam"></div>
              <div class="scan-particles">
                <div class="particle" *ngFor="let i of [1,2,3,4,5,6]"></div>
              </div>
            </div>

            <!-- Indicador de progreso -->
            <div class="scanning-progress">
              <mat-icon class="scanning-icon">search</mat-icon>
              <p class="scanning-text">Analizando recibo...</p>
              <div class="progress-dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="isImageWrong" class="form-error">
        {{ errorMessage }}
      </div>

      <!-- Botones de acción -->
      <div class="action-buttons camera-actions">
        <button
          mat-stroked-button
          color="warn"
          (click)="close()"
          [disabled]="loading"
          class="cancel-btn"
        >
          Cancelar
        </button>

        <button
          mat-fab
          color="primary"
          (click)="capturePhoto()"
          [disabled]="loading"
          class="capture-btn"
          *ngIf="!loading"
        >
          <mat-icon>camera_alt</mat-icon>
        </button>

        <button
          mat-stroked-button
          color="primary"
          [disabled]="true"
          class="processing-btn"
          *ngIf="loading"
        >
          <mat-icon>hourglass_empty</mat-icon>
          Procesando...
        </button>
      </div>
    </ng-container>
  </div>

  <div *ngIf="step === 2">
    <h2 class="dialog-title">{{ mode === 'manual' ? 'Agrega tu gasto' : 'Revisa y edita tu gasto' }}</h2>
    <app-expense-form
      [initialData]="parsedExpense ?? undefined"
      (save)="onSave($event)"
      (cancel)="onCancel()"
    ></app-expense-form>
  </div>
</div>
