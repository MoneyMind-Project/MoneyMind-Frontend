<div [class]="dialogClass">
  <button matIconButton class="close-btn" (click)="close()" aria-label="Cerrar">
    <mat-icon>close</mat-icon>
  </button>

  <div *ngIf="step === 1">
    <!-- Modo upload con drag & drop -->
    <ng-container *ngIf="mode === 'upload'">
      <h2 class="dialog-title">Sube tu recibo</h2>

      <div
        class="drag-drop-area"
        [class.drag-over]="isDragOver"
        [class.has-file]="selectedFile"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        (click)="fileInput.click()"
      >
        <!-- Área de drag & drop -->
        <div class="upload-content" *ngIf="!selectedFile && !loading">
          <mat-icon class="upload-icon">cloud_upload</mat-icon>
          <div class="upload-text">
            <p class="primary-text">Arrastra y suelta tu archivo aquí</p>
            <p class="secondary-text">o <span class="browse-link">busca</span></p>
          </div>
          <p class="file-types">Soporta: JPEG, JPG, PNG</p>
        </div>

        <!-- Preview del archivo seleccionado -->
        <div class="file-preview" *ngIf="selectedFile && !loading">
          <mat-icon class="file-icon">image</mat-icon>
          <div class="file-info">
            <p class="file-name">{{ selectedFile.name }}</p>
            <p class="file-size">{{ formatFileSize(selectedFile.size) }}</p>
          </div>
          <button
            matIconButton
            class="remove-file-btn"
            (click)="removeFile($event)"
            aria-label="Remover archivo"
          >
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Loading state -->
        <div class="loading-content" *ngIf="loading">
          <mat-icon class="loading-icon">hourglass_empty</mat-icon>
          <p class="loading-text">Procesando con Gemini...</p>
          <div class="loading-bar">
            <div class="loading-progress"></div>
          </div>
        </div>
      </div>

      <!-- Input oculto -->
      <input
        #fileInput
        type="file"
        accept="image/*"
        (change)="onFileSelected($event)"
        class="hidden-input"
      />

      <!-- Botones de acción -->
      <div class="action-buttons">
        <button
          mat-stroked-button
          color="warn"
          (click)="close()"
          class="cancel-btn"
        >
          Cancelar
        </button>
        <button
          mat-flat-button
          color="primary"
          (click)="processReceipt()"
          [disabled]="!selectedFile || loading"
          class="process-btn"
        >
          <mat-icon *ngIf="!loading">send</mat-icon>
          {{ loading ? 'Procesando...' : 'Procesar Recibo' }}
        </button>
      </div>
    </ng-container>

    <!-- Modo cámara (sin cambios) -->
    <ng-container *ngIf="mode === 'camera'">
      <h2 class="dialog-title">Escanea tu recibo</h2>
      <div class="camera-container">
        <video #video width="300" height="200" autoplay *ngIf="!loading"></video>
        <canvas #canvas width="300" height="200" [style.display]="loading ? 'block' : 'none'"></canvas>
      </div>
      <div class="action-buttons">
        <button mat-stroked-button color="warn" (click)="close()">Cancelar</button>
        <button mat-flat-button color="primary" (click)="capturePhoto()" [disabled]="loading">
          {{ loading ? 'Procesando...' : 'Capturar foto' }}
        </button>
      </div>
      <div *ngIf="loading" class="loading-message">Procesando con Gemini...</div>
    </ng-container>
  </div>

  <div *ngIf="step === 2">
    <h2 class="dialog-title">{{ mode === 'manual' ? 'Agrega tu gasto' : 'Revisa y edita tu gasto' }}</h2>
    <app-expense-form
      [initialData]="parsedExpense ?? undefined"
      (save)="onSave($event)"
      (cancel)="onCancel()"
    ></app-expense-form>
  </div>
</div>
