<!-- dashboard.html -->
<div class="dashboard-container">

  <!-- Header Section -->
  <div class="header-section">
    <div class="welcome-message">
      <h1>Hola {{ currentUser.first_name }}</h1>
      <p class="subtitle">Aqui puedes ver tus estadisticas</p>
    </div>

    <div class="notifications-section">
      <button mat-stroked-button class="notifications-btn" (click)="viewNotifications()">
        <mat-icon [matBadge]="unreadNotifications" matBadgeColor="accent" [matBadgeHidden]="unreadNotifications === 0">
          inbox
        </mat-icon>
        <span class="notifications-text"> notificaciones </span>
      </button>
      <button mat-icon-button [matMenuTriggerFor]="menu">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #menu="matMenu">
        <button mat-menu-item (click)="viewAllNotifications()">Ver todas</button>
        <button mat-menu-item (click)="markAllAsRead()">Marcar como le√≠das</button>
      </mat-menu>
      <!-- Panel de notificaciones -->
      <app-notifications-panel
        *ngIf="showNotificationPanel"
        (closePanel)="closeNotificationPanel()">
      </app-notifications-panel>
    </div>
  </div>

  <!-- KPIs Grid -->
  <div class="kpis-grid">
    <!-- üîπ Skeleton para KPIs mientras cargan -->
    <ng-container *ngIf="isLoadingKpis">
      <mat-card class="kpi-card" *ngFor="let item of [1,2,3,4]">
        <mat-card-content>
          <div class="skeleton skeleton-text skeleton-label"></div>
          <div class="skeleton skeleton-text skeleton-value"></div>
        </mat-card-content>
      </mat-card>
    </ng-container>

    <!-- ‚úÖ KPIs con datos -->
    <ng-container *ngIf="!isLoadingKpis">
      <mat-card class="kpi-card">
        <mat-card-content>
          <div class="kpi-label">Total gastado este mes</div>
          <div class="kpi-value">S/ {{ totalGastadoMes }}</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="kpi-card">
        <mat-card-content>
          <div class="kpi-label">Categor√≠a m√°s alta</div>
          <div class="kpi-value category">{{ categoriaMasAlta }}</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="kpi-card">
        <mat-card-content>
          <div class="kpi-label">Presupuesto restante</div>
          <div class="kpi-value" [ngClass]="{ 'critico': isPresupuestoCritico }">
            S/ {{ presupuestoRestante }}
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="kpi-card">
        <mat-card-content>
          <div class="kpi-label">Proyecci√≥n de gastos del pr√≥ximo mes</div>
          <div class="kpi-value">
            S/ {{ proyeccionProximoMes }}
          </div>
        </mat-card-content>
      </mat-card>
    </ng-container>
  </div>

  <!-- Charts Grid -->
  <mat-grid-list [cols]="gridCols" rowHeight="400px" [gutterSize]="'20px'">

    <!-- üîπ SKELETON: Distribuci√≥n de gastos por minicategor√≠as -->
    <mat-grid-tile [colspan]="mainChartCols" [rowspan]="1" *ngIf="isLoadingCharts">
      <mat-card class="chart-card">
        <mat-card-header>
          <div class="skeleton skeleton-text skeleton-title"></div>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-skeleton">
            <div class="skeleton skeleton-chart"></div>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-grid-tile>

    <!-- üìä GR√ÅFICO: Distribuci√≥n de gastos por minicategor√≠as -->
    <mat-grid-tile [colspan]="mainChartCols" [rowspan]="1" *ngIf="!isLoadingCharts">
      <mat-card class="chart-card flip-card" [class.flipped]="showBackCategorias">
        <div class="flip-card-inner">
          <div class="flip-card-front">
            <mat-card-header>
              <mat-card-title>Distribuci√≥n de gastos por minicategor√≠as</mat-card-title>
              <button mat-button class="filter-btn" (click)="toggleFlip('categorias')">
                Ver descripci√≥n
              </button>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas id="categoriasChart"></canvas>
              </div>
            </mat-card-content>
          </div>

          <div class="flip-card-back">
            <mat-card-header>
              <mat-card-title>Descripci√≥n del gr√°fico</mat-card-title>
              <button mat-button class="filter-btn" (click)="toggleFlip('categorias')">
                Volver al gr√°fico
              </button>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="isLoadingComments; else commentContent" class="loading-container">
                <mat-progress-spinner color="accent" mode="indeterminate" diameter="40"></mat-progress-spinner>
                <p>Generando an√°lisis con IA...</p>
              </div>
              <ng-template #commentContent>
                <p>{{ expensesByCategoryComment || 'No hay comentario disponible por el momento.' }}</p>
              </ng-template>
            </mat-card-content>
          </div>
        </div>
      </mat-card>
    </mat-grid-tile>

    <!-- üîπ SKELETON: Evoluci√≥n de ahorro -->
    <mat-grid-tile [colspan]="sideChartCols" [rowspan]="1" *ngIf="isLoadingCharts">
      <mat-card class="chart-card">
        <mat-card-header>
          <div class="skeleton skeleton-text skeleton-title"></div>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-skeleton">
            <div class="skeleton skeleton-chart"></div>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-grid-tile>

    <!-- üìä GR√ÅFICO: Evoluci√≥n de ahorro -->
    <mat-grid-tile [colspan]="sideChartCols" [rowspan]="1" *ngIf="!isLoadingCharts">
      <mat-card class="chart-card flip-card" [class.flipped]="showBackAhorro">
        <div class="flip-card-inner">
          <div class="flip-card-front">
            <mat-card-header>
              <mat-card-title>Evoluci√≥n de ahorro</mat-card-title>
              <button mat-button class="filter-btn" (click)="toggleFlip('ahorro')">
                Ver descripci√≥n
              </button>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas id="ahorroCanvas"></canvas>
              </div>
            </mat-card-content>
          </div>

          <div class="flip-card-back">
            <mat-card-header>
              <mat-card-title>Descripci√≥n del gr√°fico</mat-card-title>
              <button mat-button class="filter-btn" (click)="toggleFlip('ahorro')">
                Volver al gr√°fico
              </button>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="isLoadingComments; else ahorroCommentContent" class="loading-container">
                <mat-progress-spinner color="accent" mode="indeterminate" diameter="40"></mat-progress-spinner>
                <p>Generando an√°lisis con IA...</p>
              </div>
              <ng-template #ahorroCommentContent>
                <p>{{ savingsEvolutionComment || 'No hay comentario disponible por el momento.' }}</p>
              </ng-template>
            </mat-card-content>
          </div>
        </div>
      </mat-card>
    </mat-grid-tile>

    <!-- üîπ SKELETON: Proporci√≥n de categor√≠as padres -->
    <mat-grid-tile [colspan]="1" [rowspan]="1" *ngIf="isLoadingCharts">
      <mat-card class="chart-card">
        <mat-card-header>
          <div class="skeleton skeleton-text skeleton-title"></div>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-skeleton">
            <div class="skeleton skeleton-chart"></div>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-grid-tile>

    <!-- üìä GR√ÅFICO: Proporci√≥n de categor√≠as padres -->
    <mat-grid-tile [colspan]="1" [rowspan]="1" *ngIf="!isLoadingCharts">
      <mat-card class="chart-card flip-card" [class.flipped]="showBackPadres">
        <div class="flip-card-inner">
          <div class="flip-card-front">
            <mat-card-header>
              <mat-card-title>Proporci√≥n de categor√≠as padres</mat-card-title>
              <button mat-button class="filter-btn" (click)="toggleFlip('padres')">
                Ver descripci√≥n
              </button>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas id="proporcionChart"></canvas>
              </div>
            </mat-card-content>
          </div>

          <div class="flip-card-back">
            <mat-card-header>
              <mat-card-title>Descripci√≥n del gr√°fico</mat-card-title>
              <button mat-button class="filter-btn" (click)="toggleFlip('padres')">
                Volver al gr√°fico
              </button>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="isLoadingComments; else padresCommentContent" class="loading-container">
                <mat-progress-spinner color="accent" mode="indeterminate" diameter="40"></mat-progress-spinner>
                <p>Generando an√°lisis con IA...</p>
              </div>
              <ng-template #padresCommentContent>
                <p>{{ expensesByParentCategoryComment || 'No hay comentario disponible por el momento.' }}</p>
              </ng-template>
            </mat-card-content>
          </div>
        </div>
      </mat-card>
    </mat-grid-tile>

    <!-- üîπ SKELETON: Predicci√≥n de gastos por mes -->
    <mat-grid-tile [colspan]="1" [rowspan]="1" *ngIf="isLoadingCharts">
      <mat-card class="chart-card">
        <mat-card-header>
          <div class="skeleton skeleton-text skeleton-title"></div>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-skeleton">
            <div class="skeleton skeleton-chart"></div>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-grid-tile>

    <!-- üìä GR√ÅFICO: Predicci√≥n de gastos por mes -->
    <mat-grid-tile [colspan]="1" [rowspan]="1" *ngIf="!isLoadingCharts">
      <mat-card class="chart-card flip-card" [class.flipped]="showBackProyeccion">
        <div class="flip-card-inner">
          <div class="flip-card-front">
            <mat-card-header>
              <mat-card-title>Predicci√≥n de gastos por mes</mat-card-title>
              <button mat-button class="filter-btn" (click)="toggleFlip('proyeccion')">
                Ver descripci√≥n
              </button>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas id="prediccionChart"></canvas>
              </div>
            </mat-card-content>
          </div>

          <div class="flip-card-back">
            <mat-card-header>
              <mat-card-title>Descripci√≥n del gr√°fico</mat-card-title>
              <button mat-button class="filter-btn" (click)="toggleFlip('proyeccion')">
                Volver al gr√°fico
              </button>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="isLoadingComments; else proyeccionCommentContent" class="loading-container">
                <mat-progress-spinner color="accent" mode="indeterminate" diameter="40"></mat-progress-spinner>
                <p>Generando an√°lisis con IA...</p>
              </div>
              <ng-template #proyeccionCommentContent>
                <p>{{ monthlyPredictionsComment || 'No hay comentario disponible por el momento.' }}</p>
              </ng-template>
            </mat-card-content>
          </div>
        </div>
      </mat-card>
    </mat-grid-tile>

    <!-- üîπ SKELETON: Gastos esenciales vs no esenciales -->
    <mat-grid-tile [colspan]="lastChartCols" [rowspan]="1" *ngIf="isLoadingCharts">
      <mat-card class="chart-card">
        <mat-card-header>
          <div class="skeleton skeleton-text skeleton-title"></div>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-skeleton">
            <div class="skeleton skeleton-chart"></div>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-grid-tile>

    <!-- üìä GR√ÅFICO: Gastos esenciales vs no esenciales -->
    <mat-grid-tile [colspan]="lastChartCols" [rowspan]="1" *ngIf="!isLoadingCharts">
      <mat-card class="chart-card flip-card" [class.flipped]="showBackEsenciales">
        <div class="flip-card-inner">
          <div class="flip-card-front">
            <mat-card-header>
              <mat-card-title>Gastos esenciales vs no esenciales</mat-card-title>
              <button mat-button class="filter-btn" (click)="toggleFlip('esenciales')">
                Ver descripci√≥n
              </button>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas id="esencialesChart"></canvas>
              </div>
            </mat-card-content>
          </div>

          <div class="flip-card-back">
            <mat-card-header>
              <mat-card-title>Descripci√≥n del gr√°fico</mat-card-title>
              <button mat-button class="filter-btn" (click)="toggleFlip('esenciales')">
                Volver al gr√°fico
              </button>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="isLoadingComments; else esencialesCommentContent" class="loading-container">
                <mat-progress-spinner color="accent" mode="indeterminate" diameter="40"></mat-progress-spinner>
                <p>Generando an√°lisis con IA...</p>
              </div>
              <ng-template #esencialesCommentContent>
                <p>{{ essentialVsNonEssentialComment || 'No hay comentario disponible por el momento.' }}</p>
              </ng-template>
            </mat-card-content>
          </div>
        </div>
      </mat-card>
    </mat-grid-tile>

  </mat-grid-list>

</div>
